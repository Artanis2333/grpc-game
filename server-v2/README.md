# Server V2 - Channel è§£è€¦æ¶æ„

## æ¶æ„è¯´æ˜

è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ Channel è§£è€¦æ¶ˆæ¯æ¥æ”¶å’Œå¤„ç†çš„ gRPC æœåŠ¡å™¨å®ç°ã€‚

### æ ¸å¿ƒè®¾è®¡

```
å®¢æˆ·ç«¯è¯·æ±‚ â†’ BidirectionalStream â†’ handleRequest â†’ Channel â†’ ä¸“ç”¨åç¨‹ â†’ å¤„ç†å¹¶å“åº”
                    â†“                                              â†“
              æ¥æ”¶æ¶ˆæ¯åç¨‹                                    processActionRequests
```

## ä¸åŸå§‹æœåŠ¡å™¨çš„åŒºåˆ«

### åŸå§‹æœåŠ¡å™¨ (server/main.go)

```go
// åœ¨æ¥æ”¶æ¶ˆæ¯çš„åç¨‹ä¸­ç›´æ¥å¤„ç†
func handleRequest(...) error {
    switch req.Type {
    case REQUEST_ACTION:
        // ç›´æ¥å¤„ç†å¹¶å¹¿æ’­
        s.broadcast(response)  // åŒæ­¥æ‰§è¡Œ
    }
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… ç®€å•ç›´æ¥
- âŒ æ¶ˆæ¯æ¥æ”¶å’Œå¤„ç†è€¦åˆ
- âŒ å¤„ç†è€—æ—¶ä¼šé˜»å¡æ¥æ”¶

### Server V2 (server-v2/main.go)

```go
// å°†è¯·æ±‚å‘é€åˆ° channel
func handleRequest(...) error {
    switch req.Type {
    case REQUEST_ACTION:
        s.actionChan <- actionReq  // å¼‚æ­¥å‘é€åˆ°é˜Ÿåˆ—
    }
}

// ä¸“é—¨çš„åç¨‹å¤„ç†åŠ¨ä½œ
func processActionRequests(ctx) {
    for actionReq := range s.actionChan {
        s.handleAction(actionReq)  // å¯ä»¥è€—æ—¶å¤„ç†
    }
}
```

**ç‰¹ç‚¹**ï¼š
- âœ… æ¶ˆæ¯æ¥æ”¶å’Œå¤„ç†è§£è€¦
- âœ… å¤„ç†è€—æ—¶ä¸é˜»å¡æ¥æ”¶
- âœ… å¯ä»¥æ‰¹é‡å¤„ç†ã€æ’é˜Ÿã€é™æµ
- âœ… æ›´å®¹æ˜“æ‰©å±•ï¼ˆå¯ä»¥å¯åŠ¨å¤šä¸ªå¤„ç†åç¨‹ï¼‰

## æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Client 1                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ gRPC Stream
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 BidirectionalStream                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Goroutine: æ¥æ”¶æ¶ˆæ¯                              â”‚       â”‚
â”‚  â”‚  â”œâ”€ Recv() é˜»å¡æ¥æ”¶                               â”‚       â”‚
â”‚  â”‚  â”œâ”€ æ›´æ–° lastActive                               â”‚       â”‚
â”‚  â”‚  â””â”€ handleRequest() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                              â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Goroutine: è¶…æ—¶æ£€æŸ¥                      â”‚       â”‚       â”‚
â”‚  â”‚  â””â”€ æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡ lastActive             â”‚       â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                     Request ç±»å‹åˆ¤æ–­                 â”‚
                                                   â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                                â”‚
    HEARTBEAT                         ACTION
         â”‚                                â”‚
    ç›´æ¥å“åº”                          å‘é€åˆ° Channel
         â”‚                                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â†“
                        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   â”‚   actionChan (buffer: 100)  â”‚
                        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                 â”‚
                        â”‚                 â†“
                        â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   â”‚ Goroutine: processActions   â”‚
                        â”‚   â”‚  (åœ¨ main ä¸­å¯åŠ¨)            â”‚
                        â”‚   â”‚  â”œâ”€ ä» channel æ¥æ”¶          â”‚
                        â”‚   â”‚  â”œâ”€ handleAction()          â”‚
                        â”‚   â”‚  â”œâ”€ å¤„ç†é€»è¾‘ (å¯è€—æ—¶)        â”‚
                        â”‚   â”‚  â”œâ”€ å‘é€å“åº”ç»™å®¢æˆ·ç«¯         â”‚
                        â”‚   â”‚  â””â”€ å¹¿æ’­ç»™å…¶ä»–å®¢æˆ·ç«¯         â”‚
                        â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                 â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  å“åº”ç»™å®¢æˆ·ç«¯
```

## å…³é”®ä»£ç è§£æ

### 1. ActionRequest ç»“æ„

```go
type ActionRequest struct {
    Request  *pb.GameRequest                            // åŸå§‹è¯·æ±‚
    PlayerID string                                     // ç©å®¶ID
    Stream   pb.GameService_BidirectionalStreamServer  // å“åº”æµ
}
```

**ä¸ºä»€ä¹ˆéœ€è¦åŒ…å« Streamï¼Ÿ**
- å› ä¸ºå¤„ç†åç¨‹éœ€è¦å‘é€å“åº”ç»™å®¢æˆ·ç«¯
- Stream æ˜¯æ¯ä¸ªå®¢æˆ·ç«¯ç‹¬ç«‹çš„ï¼Œå¿…é¡»ä¿å­˜å¼•ç”¨

### 2. å‘é€åˆ° Channel

```go
case pb.RequestType_REQUEST_ACTION:
    actionReq := &ActionRequest{
        Request:  req,
        PlayerID: *playerID,
        Stream:   conn.stream,
    }
    
    select {
    case s.actionChan <- actionReq:
        // æˆåŠŸå‘é€åˆ°é˜Ÿåˆ—
    case <-ctx.Done():
        return ctx.Err()
    default:
        // channel æ»¡äº†ï¼Œè¿”å›é”™è¯¯
    }
```

**å…³é”®ç‚¹**ï¼š
- ä½¿ç”¨ `select` é¿å…é˜»å¡
- `default` åˆ†æ”¯å¤„ç†é˜Ÿåˆ—æ»¡çš„æƒ…å†µ
- ç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…å¤„ç†å®Œæˆ

### 3. ä¸“ç”¨å¤„ç†åç¨‹

```go
func (s *GameServerV2) processActionRequests(ctx context.Context) {
    for {
        select {
        case <-ctx.Done():
            return
        case actionReq := <-s.actionChan:
            s.handleAction(actionReq)  // å¯ä»¥è€—æ—¶
        }
    }
}
```

**ä¼˜ç‚¹**ï¼š
- ä¸²è¡Œå¤„ç†ï¼Œä¿è¯é¡ºåº
- å¯ä»¥æ”¹ä¸ºå¤šä¸ªåç¨‹å¹¶è¡Œå¤„ç†
- å¤„ç†é€»è¾‘ç‹¬ç«‹ï¼Œæ˜“äºæµ‹è¯•

## ä½¿ç”¨åœºæ™¯å¯¹æ¯”

### é€‚åˆä½¿ç”¨ Server V2 çš„åœºæ™¯

1. **åŠ¨ä½œå¤„ç†è€—æ—¶**
   ```
   å®¢æˆ·ç«¯è¯·æ±‚: æ”»å‡»æ€ªç‰©
   æœåŠ¡å™¨å¤„ç†: 
   - è®¡ç®—ä¼¤å®³ï¼ˆéœ€è¦æŸ¥è¯¢æ•°æ®åº“ï¼‰
   - æ›´æ–°çŠ¶æ€ï¼ˆéœ€è¦å†™å…¥æ•°æ®åº“ï¼‰
   - æ‰è½è®¡ç®—ï¼ˆå¤æ‚é€»è¾‘ï¼‰
   æ€»è€—æ—¶: 500ms
   
   ä½¿ç”¨ V2: ä¸å½±å“æ¥æ”¶å…¶ä»–æ¶ˆæ¯ âœ…
   ä½¿ç”¨ V1: 500ms å†…æ— æ³•æ¥æ”¶æ–°æ¶ˆæ¯ âŒ
   ```

2. **éœ€è¦æ’é˜Ÿå¤„ç†**
   ```
   å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¯·æ±‚åŒä¸€èµ„æº
   éœ€è¦æŒ‰é¡ºåºå¤„ç†ï¼Œé¿å…ç«æ€
   
   V2: è‡ªç„¶æ’é˜Ÿ âœ…
   V1: éœ€è¦é¢å¤–çš„é”æœºåˆ¶ âŒ
   ```

3. **éœ€è¦æ‰¹é‡å¤„ç†**
   ```go
   // å¯ä»¥æ”¹ä¸ºæ‰¹é‡å¤„ç†
   func processActionRequests(ctx) {
       batch := make([]*ActionRequest, 0, 10)
       ticker := time.NewTicker(100 * time.Millisecond)
       
       for {
           select {
           case req := <-s.actionChan:
               batch = append(batch, req)
               if len(batch) >= 10 {
                   s.handleBatch(batch)
                   batch = batch[:0]
               }
           case <-ticker.C:
               if len(batch) > 0 {
                   s.handleBatch(batch)
                   batch = batch[:0]
               }
           }
       }
   }
   ```

4. **éœ€è¦é™æµ**
   ```go
   limiter := rate.NewLimiter(100, 10)  // æ¯ç§’100ä¸ªï¼Œçªå‘10ä¸ª
   
   for actionReq := range s.actionChan {
       limiter.Wait(ctx)  // é™æµ
       s.handleAction(actionReq)
   }
   ```

### é€‚åˆä½¿ç”¨åŸå§‹ Server çš„åœºæ™¯

1. **å¤„ç†é€»è¾‘ç®€å•å¿«é€Ÿ**
   - è½¬å‘æ¶ˆæ¯
   - ç®€å•çš„çŠ¶æ€æ›´æ–°

2. **ä¸éœ€è¦æ’é˜Ÿ**
   - æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹
   - æ²¡æœ‰å…±äº«èµ„æºç«äº‰

3. **è¿½æ±‚æè‡´æ€§èƒ½**
   - å‡å°‘ä¸€æ¬¡ channel ä¼ é€’
   - å‡å°‘ä¸€ä¸ªåç¨‹çš„å¼€é”€

## è¿è¡Œæ–¹å¼

### å¯åŠ¨ Server V2

```bash
# æ–¹å¼ 1: ä½¿ç”¨ Makefile
make server-v2

# æ–¹å¼ 2: ç›´æ¥è¿è¡Œ
go run server-v2/main.go

# æ–¹å¼ 3: è¿è¡Œç¼–è¯‘åçš„äºŒè¿›åˆ¶
./bin/server-v2
```

**æ³¨æ„**ï¼šServer V2 ä½¿ç”¨ç«¯å£ `50052`ï¼Œä¸ä¼šä¸åŸå§‹æœåŠ¡å™¨å†²çªã€‚

### è¿æ¥åˆ° Server V2

éœ€è¦ä¿®æ”¹å®¢æˆ·ç«¯è¿æ¥åœ°å€ï¼š

```bash
# æ–¹å¼ 1: åœ¨ client/main.go ä¸­ä¿®æ”¹
const serverAddr = "localhost:50052"

# æ–¹å¼ 2: ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆéœ€è¦ä¿®æ”¹ä»£ç æ”¯æŒï¼‰
SERVER_ADDR=localhost:50052 go run client/main.go
```

### æµ‹è¯•åŠ¨ä½œå¤„ç†

```bash
# å¯åŠ¨ server-v2
make server-v2

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯å¯åŠ¨å®¢æˆ·ç«¯
make client

# åœ¨å®¢æˆ·ç«¯ä¸­æ‰§è¡ŒåŠ¨ä½œ
> /action æ”»å‡»æ€ªç‰©
> /action æ‹¾å–ç‰©å“
> /action ä½¿ç”¨æŠ€èƒ½
```

**è§‚å¯ŸæœåŠ¡å™¨æ—¥å¿—**ï¼š
```
åŠ¨ä½œè¯·æ±‚å·²å‘é€åˆ°å¤„ç†é˜Ÿåˆ—: ç©å®¶=Alice, åŠ¨ä½œ=æ”»å‡»æ€ªç‰©
âš¡ å¤„ç†åŠ¨ä½œ: ç©å®¶=Alice, å†…å®¹=æ”»å‡»æ€ªç‰©
âœ… åŠ¨ä½œå“åº”å·²å‘é€: ç©å®¶=Alice
```

## æ‰©å±•ç¤ºä¾‹

### å¤šä¸ªå¤„ç†åç¨‹

```go
func main() {
    gameServer := NewGameServerV2()
    pb.RegisterGameServiceServer(grpcServer, gameServer)

    // å¯åŠ¨ 5 ä¸ªå¤„ç†åç¨‹
    for i := 0; i < 5; i++ {
        go gameServer.processActionRequests(ctx, i)
    }
    
    grpcServer.Serve(lis)
}

func (s *GameServerV2) processActionRequests(ctx context.Context, workerID int) {
    log.Printf("ğŸ® Worker %d å·²å¯åŠ¨", workerID)
    for {
        select {
        case <-ctx.Done():
            return
        case actionReq := <-s.actionChan:
            log.Printf("Worker %d å¤„ç†: %s", workerID, actionReq.Request.Content)
            s.handleAction(actionReq)
        }
    }
}
```

### ä¼˜å…ˆçº§é˜Ÿåˆ—

```go
type GameServerV2 struct {
    pb.UnimplementedGameServiceServer
    highPriorityChan chan *ActionRequest  // é«˜ä¼˜å…ˆçº§
    lowPriorityChan  chan *ActionRequest  // ä½ä¼˜å…ˆçº§
    clients          sync.Map
}

func (s *GameServerV2) processActionRequests(ctx context.Context) {
    for {
        select {
        case <-ctx.Done():
            return
        case actionReq := <-s.highPriorityChan:
            s.handleAction(actionReq)
        case actionReq := <-s.lowPriorityChan:
            // åªæœ‰é«˜ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸ºç©ºæ—¶æ‰å¤„ç†ä½ä¼˜å…ˆçº§
            s.handleAction(actionReq)
        }
    }
}
```

## æ€§èƒ½è€ƒè™‘

### Channel ç¼“å†²å¤§å°

```go
actionChan: make(chan *ActionRequest, 100)
```

- **å¤ªå°**ï¼šå®¹æ˜“æ»¡ï¼Œå®¢æˆ·ç«¯æ”¶åˆ°"æœåŠ¡å™¨ç¹å¿™"é”™è¯¯
- **å¤ªå¤§**ï¼šå ç”¨å†…å­˜ï¼Œè¯·æ±‚å»¶è¿Ÿå¢åŠ 
- **å»ºè®®**ï¼šæ ¹æ® QPS å’Œå¤„ç†æ—¶é—´è®¡ç®—
  ```
  ç¼“å†²å¤§å° = é¢„æœŸ QPS Ã— å¹³å‡å¤„ç†æ—¶é—´
  ä¾‹å¦‚: 1000 QPS Ã— 0.1ç§’ = 100
  ```

### å¤„ç†åç¨‹æ•°é‡

- **å•åç¨‹**ï¼šä¿è¯é¡ºåºï¼Œé€‚åˆæœ‰çŠ¶æ€çš„å¤„ç†
- **å¤šåç¨‹**ï¼šæé«˜ååé‡ï¼Œé€‚åˆæ— çŠ¶æ€çš„å¤„ç†
- **å»ºè®®**ï¼šä» 1 å¼€å§‹ï¼Œæ ¹æ® CPU ä½¿ç”¨ç‡å’Œå»¶è¿Ÿè°ƒæ•´

## æ€»ç»“

Server V2 é€šè¿‡ Channel å®ç°äº†æ¶ˆæ¯æ¥æ”¶å’Œå¤„ç†çš„è§£è€¦ï¼Œæä¾›äº†æ›´å¥½çš„ï¼š

âœ… **å¯æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ å¤šä¸ªå¤„ç†åç¨‹
âœ… **å¯ç»´æŠ¤æ€§**ï¼šèŒè´£åˆ†ç¦»ï¼Œä»£ç æ›´æ¸…æ™°
âœ… **çµæ´»æ€§**ï¼šæ”¯æŒæ’é˜Ÿã€æ‰¹é‡ã€é™æµç­‰é«˜çº§ç‰¹æ€§
âœ… **é²æ£’æ€§**ï¼šå¤„ç†è€—æ—¶ä¸å½±å“æ¶ˆæ¯æ¥æ”¶

é€‚åˆéœ€è¦å¤æ‚ä¸šåŠ¡é€»è¾‘å¤„ç†çš„æ¸¸æˆæœåŠ¡å™¨åœºæ™¯ã€‚
